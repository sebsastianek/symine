{% extends 'base.html.twig' %}

{% block title %}Issue #{{ issue.id }}: {{ issue.subject }} - {{ project.name }} - Redmine{% endblock %}

{% block main %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    {# Breadcrumb #}
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm">
            <li>
                <a href="{{ path('project_index') }}" class="text-gray-500 hover:text-gray-700">Projects</a>
            </li>
            <li>
                <span class="text-gray-400">/</span>
            </li>
            <li>
                <a href="{{ path('project_show', {'id': project.id}) }}" class="text-gray-500 hover:text-gray-700">
                    {{ project.name }}
                </a>
            </li>
            <li>
                <span class="text-gray-400">/</span>
            </li>
            <li>
                <a href="{{ path('issue_index', {'projectId': project.id}) }}" class="text-gray-500 hover:text-gray-700">
                    Issues
                </a>
            </li>
            <li>
                <span class="text-gray-400">/</span>
            </li>
            <li class="text-gray-900 font-medium">#{{ issue.id }}</li>
        </ol>
    </nav>

    {# Issue Header #}
    <div class="bg-white shadow-sm rounded-lg p-6 mb-6">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ issue.tracker.name }}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if issue.status.isClosed %}bg-gray-100 text-gray-800{% else %}bg-green-100 text-green-800{% endif %}">
                        {{ issue.status.name }}
                    </span>
                    {% if issue.isPrivate %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            ðŸ”’ Private
                        </span>
                    {% endif %}
                </div>
                <h1 class="text-2xl font-bold text-gray-900">
                    {{ issue.tracker.name }} #{{ issue.id }}: {{ issue.subject }}
                </h1>
                <p class="mt-1 text-sm text-gray-500">
                    Added by <strong>{{ issue.author.firstname }} {{ issue.author.lastname }}</strong>
                    on {{ issue.createdOn|date('Y-m-d H:i') }}
                </p>
            </div>

            {# Actions #}
            <div class="flex items-center space-x-2 ml-4">
                {% if can_edit %}
                    <a href="{{ path('issue_edit', {'projectId': project.id, 'id': issue.id}) }}"
                       class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Edit
                    </a>
                {% endif %}
                {% if can_delete %}
                    <form method="post" action="{{ path('issue_delete', {'projectId': project.id, 'id': issue.id}) }}"
                          onsubmit="return confirm('Are you sure you want to delete this issue?');"
                          class="inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete_issue_' ~ issue.id) }}">
                        <button type="submit"
                                class="inline-flex items-center px-3 py-2 border border-red-300 shadow-sm text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {# Main Content #}
        <div class="lg:col-span-2 space-y-6">
            {# Description #}
            <div class="bg-white shadow-sm rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Description</h2>
                {% if issue.description %}
                    <div class="prose max-w-none text-gray-700">
                        {{ issue.description|nl2br }}
                    </div>
                {% else %}
                    <p class="text-gray-500 italic">No description provided.</p>
                {% endif %}
            </div>

            {# Activity / Journals #}
            <div class="bg-white shadow-sm rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Activity</h2>

                {% if journals is empty %}
                    <p class="text-gray-500 italic mb-6">No activity yet.</p>
                {% else %}
                    <div class="space-y-4 mb-6">
                        {% for journal in journals %}
                            <div class="border-l-4 border-gray-200 pl-4 py-2">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium text-gray-900">
                                                {{ journal.user.firstname }} {{ journal.user.lastname }}
                                            </span>
                                            <span class="text-sm text-gray-500">
                                                {{ journal.createdOn|date('Y-m-d H:i') }}
                                            </span>
                                            {% if journal.privateNotes %}
                                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                                    ðŸ”’ Private
                                                </span>
                                            {% endif %}
                                        </div>

                                        {# Display changes #}
                                        {% set changes = journal_details[journal.id] ?? [] %}
                                        {% if changes is not empty %}
                                            <ul class="mt-2 text-sm text-gray-600 space-y-1">
                                                {% for detail in changes %}
                                                    <li>
                                                        <span class="font-medium">{{ detail.propKey|replace({'_': ' '})|title }}:</span>
                                                        changed from
                                                        <span class="line-through">{{ detail.oldValue ?? 'empty' }}</span>
                                                        to
                                                        <span class="font-medium">{{ detail.newValue ?? 'empty' }}</span>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}

                                        {# Display notes/comment #}
                                        {% if journal.notes %}
                                            <div class="mt-2 text-gray-700">
                                                {{ journal.notes|nl2br }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Add Comment Form #}
                {% if comment_form is not null %}
                    <div class="pt-6 border-t border-gray-200">
                        <h3 class="text-md font-semibold text-gray-900 mb-3">Add a Comment</h3>
                        {{ form_start(comment_form, {'attr': {'class': 'space-y-4'}}) }}
                            <div>
                                {{ form_widget(comment_form.notes) }}
                                {{ form_errors(comment_form.notes) }}
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    {{ form_widget(comment_form.privateNotes) }}
                                    <label for="{{ comment_form.privateNotes.vars.id }}" class="ml-2 text-sm text-gray-700">
                                        {{ form_label(comment_form.privateNotes) }}
                                    </label>
                                </div>

                                <button type="submit"
                                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Add Comment
                                </button>
                            </div>
                        {{ form_end(comment_form) }}
                    </div>
                {% endif %}
            </div>
        </div>

        {# Sidebar - Issue Details #}
        <div class="space-y-6">
            <div class="bg-white shadow-sm rounded-lg p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Details</h2>
                <dl class="space-y-3 text-sm">
                    <div>
                        <dt class="font-medium text-gray-500">Status</dt>
                        <dd class="mt-1 text-gray-900">{{ issue.status.name }}</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-gray-500">Priority</dt>
                        <dd class="mt-1 text-gray-900">{{ issue.priority.name }}</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-gray-500">Assigned to</dt>
                        <dd class="mt-1 text-gray-900">
                            {% if issue.assignedTo %}
                                {{ issue.assignedTo.firstname }} {{ issue.assignedTo.lastname }}
                            {% else %}
                                <span class="text-gray-400">Unassigned</span>
                            {% endif %}
                        </dd>
                    </div>
                    {% if issue.category %}
                        <div>
                            <dt class="font-medium text-gray-500">Category</dt>
                            <dd class="mt-1 text-gray-900">{{ issue.category.name }}</dd>
                        </div>
                    {% endif %}
                    {% if issue.fixedVersion %}
                        <div>
                            <dt class="font-medium text-gray-500">Target version</dt>
                            <dd class="mt-1 text-gray-900">{{ issue.fixedVersion.name }}</dd>
                        </div>
                    {% endif %}
                    {% if issue.startDate %}
                        <div>
                            <dt class="font-medium text-gray-500">Start date</dt>
                            <dd class="mt-1 text-gray-900">{{ issue.startDate|date('Y-m-d') }}</dd>
                        </div>
                    {% endif %}
                    {% if issue.dueDate %}
                        <div>
                            <dt class="font-medium text-gray-500">Due date</dt>
                            <dd class="mt-1 text-gray-900">{{ issue.dueDate|date('Y-m-d') }}</dd>
                        </div>
                    {% endif %}
                    {% if issue.estimatedHours %}
                        <div>
                            <dt class="font-medium text-gray-500">Estimated time</dt>
                            <dd class="mt-1 text-gray-900">{{ issue.estimatedHours }} hours</dd>
                        </div>
                    {% endif %}
                    <div>
                        <dt class="font-medium text-gray-500">% Done</dt>
                        <dd class="mt-1">
                            <div class="flex items-center">
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ issue.doneRatio }}%"></div>
                                </div>
                                <span class="text-gray-900">{{ issue.doneRatio }}%</span>
                            </div>
                        </dd>
                    </div>
                    <div class="pt-3 border-t border-gray-200">
                        <dt class="font-medium text-gray-500">Created</dt>
                        <dd class="mt-1 text-gray-900">{{ issue.createdOn|date('Y-m-d H:i') }}</dd>
                    </div>
                    <div>
                        <dt class="font-medium text-gray-500">Updated</dt>
                        <dd class="mt-1 text-gray-900">{{ issue.updatedOn|date('Y-m-d H:i') }}</dd>
                    </div>
                </dl>
            </div>

            {# Subtasks Placeholder #}
            {% if issue.children is not empty %}
                <div class="bg-white shadow-sm rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Subtasks</h2>
                    <ul class="space-y-2">
                        {% for child in issue.children %}
                            <li>
                                <a href="{{ path('issue_show', {'projectId': project.id, 'id': child.id}) }}"
                                   class="text-blue-600 hover:text-blue-800">
                                    #{{ child.id }}: {{ child.subject }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
